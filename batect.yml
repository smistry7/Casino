containers:
  dotnet-sdk-container:
    image: mcr.microsoft.com/dotnet/sdk:6.0
    ports:
      - "5001:5001"
    volumes:
      - local: .
        container: /code
      - type: cache
        name: nuget-cache
        container: /root/.nuget/packages
    working_directory: /code/src/
    environment:
      ConnectionStrings__SqlConnectionString: "Data Source=sql-server-container,1433;Initial Catalog=CasinoDatabase;User ID=sa;Password=YourS3cureP@ass"
      ASPNETCORE_URLS: http://*:5001

  sql-server-container:
    build_directory: ./.batect/sql-server
    volumes:
      - local: .
        container: /code/
        options: cached
    working_directory: /code
    ports:
      - "8123:1433"
  
  redis:
    image: redis
    ports: 
      - "6001:6001"

tasks:
  run-app:
    description: run casino app
    run:
      container: dotnet-sdk-container
      command: sh -c "dotnet dev-certs https --clean && dotnet dev-certs https -t && dotnet run --project ./Casino.Api/Casino.Api.csproj --no-build"
    dependencies:
      - sql-server-container
      # - redis

  run-component-tests: 
    description: run component tests
    run: 
      container: dotnet-sdk-container
      command: dotnet test ./Casino.ComponentTests/Casino.ComponentTests.csproj
    dependencies:
      - sql-server-container